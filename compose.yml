services:
  nginx:
    image: 'nginx:1.21.3'
    expose:
      - "80"                      # no host binding; Coolify will proxy
    volumes:
      - './nginx:/etc/nginx/conf.d'
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.huly-nginx.entrypoints=http
      - traefik.http.routers.huly-nginx.rule=Host(`portal.theosirislabs.com`)
      - traefik.http.middlewares.huly-nginx-https-redirect.redirectscheme.scheme=https
      - traefik.http.routers.huly-nginx.middlewares=huly-nginx-https-redirect
      - traefik.http.routers.huly-nginx-secure.entrypoints=https
      - traefik.http.routers.huly-nginx-secure.rule=Host(`portal.theosirislabs.com`)
      - traefik.http.routers.huly-nginx-secure.tls.certresolver=letsencrypt
      - traefik.http.services.huly-nginx-secure.loadbalancer.server.port=80

  cockroach:
    image: 'cockroachdb/cockroach:latest-v24.2'
    command: 'start-single-node --accept-sql-without-tls'
    restart: unless-stopped
    volumes:
      - 'cr-data:/cockroach/cockroach-data'
      - 'cr-certs:/cockroach/certs'

  redpanda:
    image: 'docker.redpanda.com/redpandadata/redpanda:v24.3.6'
    command:
      - redpanda
      - start
      - '--kafka-addr=internal://0.0.0.0:9092,external://0.0.0.0:19092'
      - '--advertise-kafka-addr=internal://redpanda:9092,external://localhost:19092'
      - '--pandaproxy-addr=internal://0.0.0.0:8082,external://0.0.0.0:18082'
      - '--advertise-pandaproxy-addr=internal://redpanda:8082,external://localhost:18082'
      - '--schema-registry-addr=internal://0.0.0.0:8081,external://0.0.0.0:18081'
      - '--rpc-addr=redpanda:33145'
      - '--advertise-rpc-addr=redpanda:33145'
      - '--mode=dev-container'
      - '--smp=1'
      - '--default-log-level=info'
    restart: unless-stopped
    volumes:
      - 'redpanda:/var/lib/redpanda/data'

  minio:
    image: 'minio/minio:latest'
    command: 'server /data --address ":9000" --console-address ":9001"'
    restart: unless-stopped
    volumes:
      - 'files:/data'

  elastic:
    image: 'docker.elastic.co/elasticsearch/elasticsearch:7.17.9'
    restart: unless-stopped
    environment:
      discovery.type: single-node
      ES_JAVA_OPTS: '-Xms1024m -Xmx1024m'
    volumes:
      - 'elastic:/usr/share/elasticsearch/data'

  rekoni:
    image: 'hardcoreeng/rekoni-service:v0.7.242'
    restart: unless-stopped

  transactor:
    image: 'hardcoreeng/transactor:v0.7.242'
    restart: unless-stopped
    environment:
      SERVER_PORT: '3333'
      SERVER_SECRET: '${SECRET}'
      DB_URL: '${CR_DB_URL}'
      STORAGE_CONFIG: 'minio|minio?accessKey=minioadmin&secretKey=minioadmin'
      FRONT_URL: 'http://front:8080'
      ACCOUNTS_URL: 'http://account:3000'
      FULLTEXT_URL: 'http://fulltext:4700'
      STATS_URL: 'http://stats:4900'
      LAST_NAME_FIRST: '${LAST_NAME_FIRST:-true}'
      QUEUE_CONFIG: 'redpanda:9092'
      SECRET: '${SECRET}'
      CR_DB_URL: '${CR_DB_URL}'

  collaborator:
    image: 'hardcoreeng/collaborator:v0.7.242'
    restart: unless-stopped
    environment:
      COLLABORATOR_PORT: '3078'
      SECRET: '${SECRET}'
      ACCOUNTS_URL: 'http://account:3000'
      STATS_URL: 'http://stats:4900'
      STORAGE_CONFIG: 'minio|minio?accessKey=minioadmin&secretKey=minioadmin'

  account:
    image: 'hardcoreeng/account:v0.7.242'
    restart: unless-stopped
    environment:
      SERVER_PORT: '3000'
      SERVER_SECRET: '${SECRET}'
      DB_URL: '${CR_DB_URL}'
      TRANSACTOR_URL: 'ws://transactor:3333'
      STORAGE_CONFIG: 'minio|minio?accessKey=minioadmin&secretKey=minioadmin'
      FRONT_URL: 'http://front:8080'
      STATS_URL: 'http://stats:4900'
      MODEL_ENABLED: '*'
      ACCOUNTS_URL: 'http://account:3000'
      ACCOUNT_PORT: '3000'
      QUEUE_CONFIG: 'redpanda:9092'
      SECRET: '${SECRET}'
      CR_DB_URL: '${CR_DB_URL}'

  workspace:
    image: 'hardcoreeng/workspace:v0.7.242'
    restart: unless-stopped
    environment:
      SERVER_SECRET: '${SECRET}'
      DB_URL: '${CR_DB_URL}'
      TRANSACTOR_URL: 'ws://transactor:3333'
      STORAGE_CONFIG: 'minio|minio?accessKey=minioadmin&secretKey=minioadmin'
      MODEL_ENABLED: '*'
      ACCOUNTS_URL: 'http://account:3000'
      STATS_URL: 'http://stats:4900'
      QUEUE_CONFIG: 'redpanda:9092'
      ACCOUNTS_DB_URL: '${CR_DB_URL}'
      SECRET: '${SECRET}'
      CR_DB_URL: '${CR_DB_URL}'

  front:
    image: 'hardcoreeng/front:v0.7.242'
    restart: unless-stopped
    environment:
      SERVER_PORT: '8080'
      SERVER_SECRET: '${SECRET}'
      LOVE_ENDPOINT: 'http://front:8080/_love'
      ACCOUNTS_URL: 'http://account:3000'
      ACCOUNTS_URL_INTERNAL: 'http://account:3000'
      REKONI_URL: 'http://rekoni:4004'
      CALENDAR_URL: 'http://front:8080/_calendar'
      GMAIL_URL: 'http://front:8080/_gmail'
      TELEGRAM_URL: 'http://front:8080/_telegram'
      STATS_URL: 'http://stats:4900'
      UPLOAD_URL: /files
      ELASTIC_URL: 'http://elastic:9200'
      COLLABORATOR_URL: 'ws://collaborator:3078'
      STORAGE_CONFIG: 'minio|minio?accessKey=minioadmin&secretKey=minioadmin'
      TITLE: '${TITLE:-Huly Self Host}'
      DEFAULT_LANGUAGE: '${DEFAULT_LANGUAGE:-en}'
      LAST_NAME_FIRST: '${LAST_NAME_FIRST:-true}'
      DESKTOP_UPDATES_CHANNEL: 'v0.7.242'
      SECRET: '${SECRET}'

  fulltext:
    image: 'hardcoreeng/fulltext:v0.7.242'
    restart: unless-stopped
    environment:
      SERVER_SECRET: '${SECRET}'
      DB_URL: '${CR_DB_URL}'
      FULLTEXT_DB_URL: 'http://elastic:9200'
      ELASTIC_INDEX_NAME: 'huly_storage_index'
      STORAGE_CONFIG: 'minio|minio?accessKey=minioadmin&secretKey=minioadmin'
      REKONI_URL: 'http://rekoni:4004'
      ACCOUNTS_URL: 'http://account:3000'
      STATS_URL: 'http://stats:4900'
      QUEUE_CONFIG: 'redpanda:9092'
      SECRET: '${SECRET}'
      CR_DB_URL: '${CR_DB_URL}'

  stats:
    image: 'hardcoreeng/stats:v0.7.242'
    restart: unless-stopped
    environment:
      PORT: '4900'
      SERVER_SECRET: '${SECRET}'
      SECRET: '${SECRET}'

volumes:
  cr-data:
  cr-certs:
  redpanda:
  files:
  elastic:
